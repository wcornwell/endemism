---
title: "endemism"
format: html
editor: visual
---

## Endemism

We love endemism

```{r}
#install packages


#load libraries
library(tidyr)
library(tidyverse)
library(data.table)
library(dplyr)

#read csvs
genus_end <- read.csv("data/australian_flora/genus_level_endemism_estimate.csv")

#wcvp <- fread(file = "data/wcvp/wcvp_names.csv", header = T)
#wcvp_distribution <- fread(file = "data/wcvp/wcvp_distribution.csv", header = T)


ng <- read.csv("data/other_countries_floras/sa_2022-07-12_072627325-BRAHMSOnlineData.csv")
nz <- fread("data/other_countries_floras/checklistofthenewzealandflora-seedplantsseptember2020.tsv")
nz2 <- fread("data/other_countries_floras/checklistofthenewzealandflora-fernsandlycophytesseptember2020.tsv")
nc <- read.csv("data/other_countries_floras/Florical_vers_7_I_2022.csv")
indo <- read.csv("data/other_countries_floras/oo_377596.csv")

redlist <- read.csv(file = "data/REDLIST_Folder/simple_summary.csv", header = T)

fivesource <- read.csv(file = "intermediate_data/summary_current.csv", header = T) #Contains outside Aus proportions and endemicity estimates
```

```         
##Adding NZ Data
```

```{r}
#combine nz and nz2 
nz <- rbind(nz, nz2)

#make new df for genus that are possibly endemic (ie score a 1 on genus_end df)
ausplants <- subset(genus_end, prop_endemic == 1)

#remove ? from genus column value in nz data
nz$Genus <- gsub("\\?", "", nz$Genus)

#make a subset for the genus in nz data that appear to have no genus 
no_genera_nz <- subset(nz, Genus == "")
nrow(no_genera_nz) #324 - a problem for another day
nz<-filter(nz, Origin!="Exotic")

ausplants$nz <- ausplants$genus %in% nz$Genus
```

##Adding NC column

```{r}
ausplants$nc <- ausplants$genus %in% nc$Genre
```

##Adding NG column

```{r}
ausplants$ng <- ausplants$genus %in% ng$Genus

```

##Add Indonesian column

```{r}
ausplants$indo <- ausplants$genus %in% indo$Genus
```

###Combining WCVP Distribution and the the Other Thingo

```{r}

wcvp_distribution <- read_csv('data/wcvp/wcvp_distribution.csv')
wcvp <- read_csv('data/wcvp/wcvp_names.csv')

wcvp_comb <- wcvp_distribution %>%
  left_join(wcvp, by = 'plant_name_id') 

wcvp_not_aus <- wcvp_comb %>%
  filter(region != "Australia") #removing all Australian plants

wcvp_aus <- wcvp_comb %>%
  filter(region == "Australia")

sort(unique(wcvp_comb$region)) #does not provide country, but general geographic region
sort(unique(wcvp_aus$area))
print(wcvp_not_aus[wcvp_not_aus$area == "", ])


```

### Adding WCVP Column

```{r}
ausplants$wcvp <- ausplants$genus %in% 
  wcvp_not_aus$genus 
```

### Adding Threatened Status

```{r}
library(dplyr)
library(data.table)
redlist <- redlist %>%
  filter(genusName %in% fivesource$genus) #Filters redlist data to only include genera within fivesource data

unique(redlist$redlistCategory) 
#[1] "Endangered"                 "Critically Endangered"      "Vulnerable"                
#[4] "Least Concern"              "Near Threatened"            "Lower Risk/near threatened"
#[7] "Data Deficient"             "Extinct"

print(redlist[redlist$redlistCategory == "Extinct", ]) #Is Extinct required, should remove? 

#redlist <- redlist %>%
  #filter(redlistCategory != "Extinct")

unique(redlist$genusName) #`182 genera`

counts <- redlist %>% #Creating counts frame for each threatened status
  group_by(genusName) %>%
  count(redlistCategory) %>%
  pivot_wider(names_from = redlistCategory, values_from = n, values_fill = NA) 

# Join the counts with fivesource.trial based on genera2
genus_with_status <- fivesource %>%
  left_join(counts, by = c("genus" = "genusName")) %>% #Lower Risk/ Near Threatened has one value - Maybe combine with Near Threatened?
  mutate_at(c(15:22), ~replace_na(.,0))

#Maybe add proportions??
```

```{r}
genus_with_status$species_number <- as.numeric(genus_with_status$species_number)

options(max.print = 10000)
print(rowSums(genus_with_status[15:22], na.rm = T) > genus_with_status$species_number)

comparison_result <- rowSums(genus_with_status[15:22], na.rm = TRUE) > genus_with_status$species_number


print(genus_with_status[comparison_result, ])
#Arthrotaxis has 2 vulnerable and 1 endangered, with 2 recorded species
#Genoplesium has one recorded spcies, but has critically endangered and one endangered
#Polypogon has one species but 2 least-concern

print(redlist[redlist$genusName == "Athrotaxis", ]) #Athrotaxis laxifolia, Athrotaxis cupressoides, Athrotaxis selaginoides
print(redlist[redlist$genusName == "Genoplesium", ]) #Genoplesium insigne, #Genoplesium baueri 
print(redlist[redlist$genusName == "Polypogon", ]) #Polypogon viridis, Polypogon monspeliensis
```

## Write CSV

```{r}
write_csv(genus_with_status,"intermediate_data/summary_current.csv")
```

## Adding Austraits data - dispersal + growth form traits - for ALL australian genera

```{r}
##create df with all australian genera for comparison

aus_genera <- read_csv('data/australian_flora/genus_level_endemism_estimate.csv')

ausplants <- read_csv('intermediate_data/summary_current')

#create non-endemic subset where proportion endemic aus species was <1 (from 2022 Big Data Project)
non_end <- subset(aus_genera, prop_endemic < 1)

#create endemism classification column
non_end$endemism_status <- 'non-endemic'

all_aus_genera <- rbind(non_end[ , c(1,4)], ausplants[ , c(1,13)])


#load austraits
devtools::install_github("traitecoevo/austraits")
austraits <- load_austraits(version = "4.1.0", path = "intro/downloads")

#make genus_list from our australian genera df
genus_list <- all_aus_genera$genus

#now select the categorical traits we want to extract - dispersal appendage, syndrome, plant growth form using the extract_trait function
cat_traits <- austraits %>% extract_trait(c('dispersal_appendage', 'dispersal_syndrome', 'plant_growth_form'))

#join traits to produce dataframe 
cat_traits_joined <- left_join(cat_traits[["traits"]], cat_traits[["taxa"]], by = "taxon_name")

#keep only records for genera on our australian genera list
cat_traits_joined <- cat_traits_joined[cat_traits_joined$genus %in% genus_list, ]

#pivot df such that each row is a genus from the australian genera list, and the most commonly recorded plant growth, dispersal appendage, dispersal syndrome traits are applied for each genus
austraits_genera <- cat_traits_joined %>%
  select(genus, trait_name, value) %>%
  pivot_wider(names_from = trait_name, values_from = value, values_fn = max)

#now the same for seed_traits
disp_traits <- austraits %>% extract_trait(c('seed_dry_mass', 'plant_height'))

#seed traits joined
disp_traits_joined <- left_join(disp_traits[["traits"]], disp_traits[["taxa"]], by = "taxon_name")

#keep only records for genera on our australian genera list
disp_traits_joined <- disp_traits_joined[disp_traits_joined$genus %in% genus_list, ]

#pivot df such that each row is a genus from the australian genera list, and the mean of recorded dry_seed_mass are applied for each genus
disp_genera <- disp_traits_joined %>%
  select(genus, trait_name, value) %>%
  pivot_wider(names_from = trait_name, values_from = value, values_fn = mean)


#add categorical traits and numerical seed mass traits together
austraits_genera <- left_join(austraits_genera, disp_genera, by = 'genus')

write_csv(austraits_genera, 'intermediate_data/all_gen_with_traits.csv')

```

wilcox rank sum tests for plant height and seed mass

```{r}

#contains australian genera and selected traits
austraits_genera <- read_csv('intermediate_data/all_gen_with_traits.csv')

#adding the endemism status to this dataframe for subsequent plotting and tests
genera <- merge(austraits_genera, all[1:2], by = 'genus', all.x = TRUE)


library(rstatix)
#wilcox rank sum test for seed_dry_mass
seed_test <- genera %>% 
  wilcox_test(seed_dry_mass ~ endemism_status) %>%
  add_significance()
seed_test #p < 0.0.000733, significant

#wilcox rank sum test for plant_height
height_test <- genera %>% 
  wilcox_test(plant_height ~ endemism_status) %>%
  add_significance()
seed_test #p < 0.0.0005, significant

```

Seed mass plots

```{r}
#plotting of seed_dry_mass - violin plot w boxplot
ggplot(genera, aes(x = endemism_status, y = seed_dry_mass_log, fill = endemism_status)) +
  geom_violin() +
  scale_fill_brewer() +
  labs(fill = 'Endemic status', x = 'Endemic status', y = 'Seed dry mass (log)') + 
  theme_bw()  +
  geom_boxplot(width=0.05) 

#plotting of seed_dry_mass - boxplot
ggplot(genera, aes(x = endemism_status, y = seed_dry_mass_log, fill = endemism_status)) +
  geom_boxplot() +
  scale_fill_brewer() +
  labs(fill = 'Endemic status', x = 'Endemic status', y = 'Seed dry mass (log)') + 
  theme_bw()  
```

Plant height plots

```{r}
#plant height plots - violin w boxplot
ggplot(genera, aes(x = endemism_status, y = plant_height, fill = endemism_status)) +
  geom_violin() +
  scale_fill_brewer() +
  labs(fill = 'Endemic status', x = 'Endemic status', y = 'plant height (cm)') + 
  theme_bw()  +
  geom_boxplot(width=0.05) 

#plant height plots - boxplot
ggplot(genera, aes(x = endemism_status, y = plant_height, fill = endemism_status)) +
  geom_boxplot() +
  scale_fill_brewer() +
  labs(fill = 'Endemic status', x = 'Endemic status', y = 'plant height (cm)') + 
  theme_bw() 
```

Plotting plant growth form - proportionally

```{r}
#plot growth form - yields 25 different categories - not great visualisation of data
ggplot(genera, aes(x = endemism_status, fill = plant_growth_form)) +
  geom_bar() +
  theme_bw()

#simplifying growth form to combine categories which begin with climber, fern, graminoids, shrub/include shrub, tree, herb. new column growth_form_simp
genera <- genera %>%
  mutate(growth_form_simp = case_when(
    startsWith(plant_growth_form, "climber") ~ "climber",
    startsWith(plant_growth_form, "fern") ~ "fern",
    startsWith(plant_growth_form, "graminoid") ~ "graminoid",
    startsWith(plant_growth_form, "shrub") ~ "shrub",
    grepl("shrub", plant_growth_form, ignore.case = TRUE) ~ "shrub",
    startsWith(plant_growth_form, "tree") ~ "tree",
    startsWith(plant_growth_form, "herb") ~ "herb",
    TRUE ~ plant_growth_form
  ))

#calculating proportion of each simplified growth form
proportions_data <- genera %>%
  group_by(endemism_status, growth_form_simp) %>%
  summarize(count = n()) %>%
  group_by(endemism_status) %>%
  mutate(proportion = count / sum(count))

#remove graminoids, lycophyte, palmoids for plotting as these contain ~1 species 
proportions  <- proportions_data  %>%
  filter(!(growth_form_simp %in% c("palmoid", "lycophyte", "graminoid")))

#plotting growth forms as a proportion of total number of endemic and non-endemic genera

ggplot(proportions, aes(x = endemism_status, y = proportion, fill = growth_form_simp)) +
  geom_bar(stat = "identity") +
  labs(x = "Endemism Status", y = "Proportion of genera", title = "Plant growth forms of endemic and non-endemic genera", fill = 'Simplified growth form') +
  theme_bw() 
```

Chi square test for plant growth form

```{r}
#contingency table for growth form
cont_form <- table(genera$growth_form_simp, genera$endemism_status)

#chi square test
chi <- chisq.test(cont_form, correct = F)

# calculate the Pearson residuals
residuals <- stats::residuals(chi, type = "pearson")

# add the residuals to the contingency table for observation
cont_form_with_residuals <- cbind(cont_form, residuals)

# Print the contingency table with residuals
print(cont_form_with_residuals)
#          endemic non-endemic    endemic non-endemic
#climber        11          73 -3.0708418   2.1099420
#fern            1          71 -4.5970974   3.1586156
#graminoid       3           4  0.5040022  -0.3462944
#herb          236         440  1.3047337  -0.8964683
#lycophyte       0           7 -1.4982859   1.0294559
#palmoid         1           3 -0.2496716   0.1715467
#shrub         261         274  6.8273695  -4.6910113
#tree          152         456 -3.0781587   2.1149694
#tussock        37         159 -3.2612890   2.2407962

#now the chi square, but only considering tree, shrub, herb for simplicity
filtered <- genera %>% 
  filter(growth_form_simp == c('tree', 'shrub', 'herb'))

#contingency table
cont_form_f <- table(filtered$growth_form_simp, filtered$endemism_status)

#chi square test
chi_f <- chisq.test(cont_form_f, correct = F)


#calculate the Pearson residuals
residuals <- stats::residuals(chi_f, type = "pearson")

#add the residuals to the contingency table for observation
cont_form_with_residuals <- cbind(cont_form_f, residuals)

#print the contingency table with residuals
print(cont_form_with_residuals)
#endemic non-endemic    endemic non-endemic
#herb       83         141  0.1712374  -0.1294433
#shrub      86          90  2.7500000  -2.0788046
#tree       47         147 -2.8033193   2.1191102

#now we apply a boneferri correction 


# Total number of cells in the contingency table
total_cells <- length(residuals)

# Bonferroni corrected significance threshold (alpha)
alpha_bonferroni <- 0.05 / total_cells

# Calculate the Bonferroni-corrected p-values
p_values <- chi_square_test$p.value
p_values_bonferroni <- p_values * total_cells

# Identify the indices of the cells with significant residuals
significant_cells_bonferroni <- which(abs_residuals > qnorm(1 - alpha_bonferroni / 2), arr.ind = TRUE)

# Print the row and column indices of the significant cells with Bonferroni correction
print(significant_cells_bonferroni)
#      row col
#shrub   2   1
#tree    3   1
```
